# 物联网设备漏洞检测 综述 两篇

## 物联网设备漏洞挖掘技术研究综述 ——信息安全学报

### 文章重点：

 随着物联网设备的迅速发展和广泛应用, 物联网设备的安全也受到了严峻的考验。安全漏洞大量存在于物联网设备中, 而通用漏洞挖掘技术不再完全适用于物联网设备。近几年, 针对物联网设备漏洞的挖掘技术逐渐成为热点。本文将分析物联网 设备漏洞挖掘技术面临的挑战与机遇, 然后从静态分析, 动态模糊测试, 以及同源性分析三个方面来介绍物联网设备漏洞挖掘 技术的研究进展。后本文将对今后该领域的研究重点和方向进行讨论和展望

---

物联网设备漏洞挖掘技术与通用软件 漏洞挖掘技术相辅相成, 发展现状主要概括为以下 几个方面: 

- 静态分析
- 动态模糊测试
- 同源性分析

静态分析主要以**物联网设备固件**作为分析对象, 对 固件进行解析, 并建立特定漏洞类型的分析规则, 进一步使用**静态程序分析技术挖掘漏洞**。

动态分析 通过对**真实运行设备**或**模拟仿真系统**进行测试从而 发现漏洞。

基于同源性分析的漏洞发现是因物联网设备大量**复用**开源项目带来的新兴研究方向。

从 2014年到现在, 仅仅5年时间, 即从第一篇基于文件 粒度的漏洞关联, 到基于函数粒度的漏洞关联, 发 展到现在基于深度学习的高效漏洞关联。总体来说, 物联网设备漏洞挖掘技术仍处于起步阶段, 有很多 开放性的研究问题。 

### 文章结构

第二章论述当前通用漏洞挖掘技术的现状, 并理清物联网设备系统与通用软件 存在差异性, 在此基础上分析出物联网设备漏洞 挖掘技术存在的机遇和挑战

**（当前现状、物联网设备与通用软件的差异性、物联网漏洞挖掘的机遇和挑战）**

在三、四、五 章分别介绍**静态分析、动态模糊测试、同源性分析** 三种物联网设备漏洞挖掘技术; 

第六章将**总结**全 文并展望

---

### 二、物联网设备漏洞挖掘的挑战和机遇 

1. 概述

   通用漏洞挖掘技术根据**分析对象**主要分为两大类: 

- 基于源代码的漏洞挖掘
- 基于二进制的漏洞挖掘

基于源代码的分析通常采用**静态分析**方案, 先建立特定漏洞检测规则, 并采用数据流分析、污点分析、符号执行等技术完成相应规则检测, 从而实现漏洞的挖掘。

由于二进制代码通常是可执行的, 因此基于二进制的方案分为**静态、动态、动静结合**的。

> ​	静态二进制分析方案需要首先**将二进制代码转换成汇 编代码,** 或是进一步转换成统一表示的中间语言。之 后可以通过基于模式的漏洞分析或是**二进制代码比对技术实现静态**的漏洞挖掘。
>
> ​	动态二进制分析方案主要是采用**模糊测试**技术。根据输入制导的方式可分 为白盒、灰盒以及黑盒测试。
>
> ​	动静结合的方案主要将静态分析的结果用于辅助动态测试。 

2. 挑战

   - 硬件资源受限

   - 硬件的复杂异构

   - 代码文档未公开

3. 机遇

   - 系统交互的丰富性
   - 组件代码的大量复用
   - 漏洞类型的趋同性

   ---

### 三、静态分析

 物联网 设备漏洞挖掘更关注特定漏洞类型和模块, 如硬编 码、认证绕过等后门漏洞。

该漏洞类型属于物联网 设备特定漏洞, 通常为了方便设备调试人员进入系 统或进行特权操作。其在物联网设备上普遍存在, 而 在通用程序上较为少见

> 针对硬编码漏洞类型, Thomas[14]等提出基于静态数据分析的漏洞挖掘方法。
>
> ​	该工作首先识别出程序中的静态数据比对函数, 通过提取函数特征，并对静态数据比对函数进行建模来识别。
>
> ​	接着通过程序控制流分析技术来判定静态数据比对的重要性(根据它影响代码块的独特性), 之后进一步评估出函数的重要性。通过进一步对重要性函数的静态分析, 发现了硬编码的认证后门漏洞, 并恢复出 FTP、SOAP 协 议的重要指令集。该工作具有很强的实用性, 然而在 后门漏洞挖掘与基于文本的协议指令恢复的这两个 应用中, 均不能保证准确性和召回率。因此, 该方案 在大规模测试中的适用性无法得到保证。为了进一 步识别物联网设备固件程序中的后门, Thomas[10]利 用半监督学习的方法, 构造了识别固件中二进制功 能的分类器。并通过自定义二进制函数功能描述语 言, 识别二进制中的非预期功能(后门)。实验表明有 96.45%的二进制功能的识别准确率, 并在 Tenda 设备中挖掘出后门漏洞。 

> 针对认证绕过漏洞类型, Shoshitaishvili 等[13]提 出基于程序分析的物联网设备认证绕过漏洞的挖掘 方法。首先, 该工作人为定义程序特权点(包括未认 证的情况下不能输出的数据、未认证情况下不可执 行的系统操作、对内存绝对地址的访问、人工分析 出的相关特权函数)。在此基础上, 构建固件代码的 控制流、数据依赖、控制依赖图, 然后基于切片技术 生成到特权点的路径, 并采用符号执行技术求解路 径条件, 从而发现物联网设备认证绕过漏洞。该工作 采用切片技术对程序路径进行简化, 使符号执行分 析有较高的分析性能。然而, 该工作无法解决程序被 混淆之后的分析难题。

>  针对通用污点类漏洞类型, Cheng 等[15]提出物联 网设备固件污点类漏洞的检测方法, 主要通过函数 分析提取变量描述、定义对、数据类型等信息, 并解 决函数数据流分析、指针别名分析、数据结构恢复 等难题。该工作发现了 8 个已知漏洞和 13 个 0day 漏洞, 且在时间开销上优于 Angr。 

> 针对协议解析模块, Cojocar 等[16]首次提出基于 协议解析模块识别的物联网设备漏洞挖掘方法。该 工作通过协议解析模块离散特征的提取以及分类器 的构造, 实现协议解析模块的精确识别, 并聚焦于 该类模块的漏洞挖掘, 发现 GPS 接收器、电表、硬 盘驱动、程序逻辑控制器(PLC)多类型物联网设备的 漏洞。在此基础上, Zheng 等[17]提出基于多维度特征 的应用层协议解析模块的识别技术, 并与基于二进 制属性图的可疑脆弱点推断技术相结合, 实现污点 类漏洞的快速发现。 目前基于程序分析的漏洞发现技术能够有效的 针对特定漏洞类型(硬编码、认证绕过、污点类)和模 块(协议解析模块)。然而这些研究工作大多需要人工 辅助, 自动化程度不足。此外, 研究工作的分析对象 仍然是用户程序。在针对物联网设备特定实时操作 系统方面, 仍然缺少相应的漏洞挖掘工作

---

设备仿真技术

**对物联网设备进行灰盒测试, 设备仿真技术是 不可缺少的**。若不采用设备仿真技术, 而对硬件设备 直接进行灰盒测试, 则需要采用硬件监控的机制来 获取执行信息。由于在硬件监控机制上, 仅有通用平 台的芯片(如INTEL)实现了程序执行跟踪功能, 而物 联网设备芯片(ARM、MIPS 等)不支持, 因此无法对 真实设备直接进行灰盒测试。另外, 厂商很少提供物 联网设备程序的源代码, 直接在源代码中插桩监控 代码也不现实。因此, 只能基于设备仿真技术, 并对 仿真器进行插桩以实现灰盒测试。 

在用户态仿真的工作中, AFL 模糊测试工具采用 QEMU 动态翻译模拟器, 按照代码块粒度对
目标程序指令进行翻译和执行, 保证了程序执行的 高效性。其中, 指令翻译是将目标程序的指令(通常 是 ARM、MIPS 等)翻译成宿主机的指令(通常是 X86)。但对于物联网设备程序, 其依赖的系统环境和 硬件设备通常与宿主机不一致。当目标程序进行系 统调用时, QEMU 将其转化为宿主机对应的系统调 用并进行执行。由于目标程序依赖的系统环境和宿 主机存在不一致性, 系统调用结果也会不同, 导致 后续代码执行发生错误。 

在混合仿真的研究工作中, 为了解决物联网设 备程序的正确执行问题, Zaddach 等[提出混合仿真 系统 Avatar, 通过更好的硬件支持实现物联网设备 固件的动态仿真。其核心思想是连接模拟器(QEMU) 和真实硬件进行混合执行, 即控制模拟器端完成固 件指令的翻译和执行, 并将I/O操作引导到真实设备 端完成。在此基础上, Avatar 使用符号执行技术发现 嵌入式设备的硬编码漏洞。然而, 该工作存在以下局 限性: 由于符号执行技术的引入以及软硬件之间的 频繁交互, 性能相比于真实设备执行下降很多; 且 难以对设备的外围 I/O 进行自动化的连接使用。为了 克服 Avatar 仿真的时效性差, Koscher 等[44]提出基于 FPGA桥接器串行连接的物联网设备调试方法, 实现 物联网设备的近实时动态仿真和分析

在系统态仿真的研究工作中, 为了克服模糊测 试等动态分析技术对硬件的依赖性, Chen 等[45]提出 针对 Linux 内核物联网设备固件的大规模全系统仿 真平台 Firmadyne, 通过修改内核和驱动来添加硬件 支持以实现物联网设备的全系统仿真。该工作主要 解决了定制化外围 I/O、非易失性内存、动态文件等 仿真技术难题。该系统支持 ARM 和 MIPS 两种 CPU 架构, 并完成9486固件的解压和74个漏洞利用脚本 的测试。在此基础上, Costin 等[46]提出物联网设备 Web 接口的测试方法, 发现45个固件Web 接口的未 知漏洞。在系统仿真的基础上, TEMU[47]通过采用客 户机驱动来获取客户机的运行状态信息。DECAF[48] 与 TEMU 不同, 通过对 QEMU 进行插桩来访问客户 机的内核数据结构, 从而实时获取客户机的进程、线 程、代码块、符号等信息。该系统支持 ARM、MIPS、 X86 CPU 架构以及 windows、Linux 操作系统。 

在仿真工作的基础上, 黑盒测试相关工作被提 出。Muench 等[49]比较了各种不同配置下的黑盒测试 效率, 包括本地执行(直接测试真实设备)、半仿真、 全系统仿真。其中, PANDA[50]提供其仿真技术。通过 实验发现, 由于桌面系统处理器比物联网设备处理 器快, 全系统仿真比本地执行有更高的执行性能。然而, 测试吞吐率快也没有超过 15 个/秒。 

另一方面, 基于系统仿真的灰盒测试研究工作 也有一定的进展。TriforceAFL[51]将 AFL 与 QEMU 系统态仿真结合, 实现全系统仿真下的模糊测试。其 中完整实现了对系统仿真下内核的灰盒测试。Zheng 等[52]在 TriforceAFL 的基础上, 利用 DECAF 的客户 机进程实时监控技术, 实现对物联网设备用户程序 的模糊测试技术。同时, 为了解决全系统仿真性能较 差的问题, 有效结合 QEMU 用户态程序仿真的高性 能和系统态仿真的高兼容性, 提出基于内存映射共 享技术和系统调用重定向技术的增强进程仿真机制, 并与 AFL 测试引擎结合, 在保证测试准确性的前提 下, 大幅提高灰盒测试的性能。 

---

在外围系统分析的研究中, Chen 等[53]提出 APP 分析与模糊测试相结合的物联网设备内存破坏类漏 洞挖掘的工具 IoTFuzzer。

由于很多物联网设备带有 官方 APP, 且 APP 中含有丰富的协议信息(URL、命 令、加解密信息), 通过自动化分析相关移动 APP 中 的数据流信息, 更好的了解未知通信协议, 从而生 成更好的测试样例来发现漏洞。整个 APP 分析分为 两个步骤: UI 分析和数据流分析。UI 分析主要是找 到 UI 元素到网络 API 之间的程序路径, 即找到网络 API 相关的事件; 数据流分析采用污点跟踪技术, 以 用户输入、硬编码字符串、系统 API 作为污点源, 而 将网络 API 和加密函数作为敏感点, 通过污点传播分析, 识别出协议字段以及接受协议字段的函数。在 模糊测试部分, 针对 APP 分析发现的字段, 对参数 字段进行变异。策略包括: 针对字符串参数, 通过更 改长度以尝试发现堆栈溢出漏洞; 对数值参数, 更 改值以发现整数溢出漏洞; 另外改变值的类型或者 提供空值。实验挖掘出 9 个设备中 15 个多类型内存 破坏类漏洞(4个空指针引用, 5个栈溢出, 2个堆溢出, 4 个未知漏洞)。同时, 与 Sulley, BED 两个模糊测试 系统做了对比, 由于预先做了 APP 分析来制导输入 生成, 挖掘效率有了很大的提高。 

​	IoTFuzzer 存在一定的局限性, 包括: (1)物联网 设备需要有相关的 APP 用于分析, 而对于很多物联 网设备来说, 没有对应的APP; (2)需要真实物理设备 用于连接测试; (3) 仍然存在性能问题, 吞吐率没有 超过1个/秒; (4)该工具通过崩溃检测来发现漏洞, 然 而在文献中也提到, 很多溢出类漏洞不一定造成程 序崩溃; (5)测试的代码覆盖率只包含处理与 APP 交 互的那部分代码。 



总结:

除了模糊测试引擎, 以及用于制导模 糊测试输入生成的监控模块与通用模糊测试基本一 致以外, 新型攻击面测试, 异常检测, 外围系统分析, 设备仿真都存在严峻挑战。

在新型攻击面测试方面, 需要研究物联网设备特殊协议和内核新型攻击面的 测试技术。

在物联网设备异常检测方面, 仅仅通过外 部存活性探测的方式已不能准确判断异常, 需要综 合程序堆栈状态和硬件输出等多层级行为来准确判 断。

在外围系统分析方面, 主要是针对传统的基于输入随机变异的方式不再适用物联网设备的问题。需 要借助对外部交互软件的分析, 提取出协议语法信 息, 从而实现基于生成的模糊测试, 提高模糊测试 的测试深度。

在设备仿真技术方面, 需要支持物联网 设备的精准执行以及执行信息的提取。目前, 可以支 持比较多的是网络摄像头、路由器等基于 Linux 内核 的固件, 对于其他非Linux内核以及无操作系统固件, 还支持的较少。此外, 由于可仿真的物联网设备数量 非常有限, 不利于模糊测试技术的评测, 因此可以 通过文献[55]中的技术来插入真实的漏洞作为评测对象

---

Lakhotia 等[59]提出基于语义模板的相似代码片 段快速关联方法。在此基础上, Pewny 等[60]提出基于 语义签名的漏洞关联算法, 将基本块内指令转化为 表达式进行相似度匹配, 提高了相同代码架构下漏 洞函数的关联精度。为了实现跨 CPU 架构的漏洞发 现, Pewny 等[61]将不同指令代码转化为中间语言, 利 用 hash 生成漏洞基本块的摘要, 并结合代码控制流结构进行图匹配, 从而实现精确的同源漏洞发现。然 而该工作没有对物联网设备固件代码进行分析, 且 需要对每个基本块的输入输出进行特征提取, 存在 较大的性能开销。 

针对语义特征提取带来的较大性能开销问题, Eschweiler 等[62]提出基于算数和调用指令数量等轻 量级语法特征的图匹配方法, 并在匹配前采用函数 级特征预分析以提高搜索效率。该工作仍然依赖图 匹配模型, 具有较大的开销, 性能瓶颈没有得到彻 底解决。因此, Feng 等[63]提出基于控制流图嵌入匹配 的固件同源漏洞发现方法, 通过代码库将控制流图 编码成特征向量(图嵌入), 并使用局部敏感哈希进行 索引, 能够快速发现跨平台物联网设备固件的漏洞。

该工作实现了一定规模物联网设 备同源漏洞的快速发现, 但在训练图嵌入所需的代 码库时仍有较大的时间开销, 且代码库质量受训练 集影响

 Xu 等[64]提出基于神经网络的 跨平台相似代码检测方法, 训练时间从 1 周下降到 30 min~10 h, 相较于上述方法能够识别出更多额外 的漏洞代码

此外, 针对物联网设备固件跨平台漏洞关联准 确率低的问题, 常青等[65]提出基于神经网络和局部 调用结构匹配的两阶段跨平台关联方法。该方法先 从函数间调用图、函数内控制流图、函数基本信息 三类中选择特征, 然后数值、归一化处理, 接着利用 神经网络实现函数对相似性的比对, 并利用结构特 征进一步提升精确度。该方法在 OpenSSL 二进制文 件上的匹配性能指标 Top1 上有超过两倍的提升, 且 在 DLink 路由器固件的漏洞函数关联上有很好的效 果。该工作实现了一定规模物联网设备固件的同源 漏洞精准发现

物联网设备漏洞的同源性分析从初的粗粒度 文件相似性比对到细粒度的代码块(函数)相似性比 对, 从代码块语义特征(输入输出对)提取, 到轻量级 语法、结构特征提取, 从基于图结构的匹配到基于图 嵌入特征的匹配, 漏洞关联速度和精准度有了很大 的提升。目前的技术能够有效提取文件或代码块的 特征并进行高效编码, 通过敏感哈希索引等方式, 保证了同源漏洞搜索的性能和精确性。 

---

总结

当前的物联网设备的漏洞挖掘技术在静态分 析、动态模糊测试、同源性分析技术上都有一定的 进展。其中, 静态分析技术能够有效解决固件的解析, 以及固件中通用漏洞的分析问题。但对于物联网设 备特定漏洞的高效分析, 仍然缺乏深入的思考和探 究。此外, 对于无操作系统和包含特定嵌入式操作系 统的固件, 仍然缺少系统性的分析和研究

对于模糊测试技术, 目前能够实现部分设备(如 路由器、网络摄像头)固件的高效仿真和灰盒测试, 从而快速发现漏洞。但对于整个物联网设备生态, 目 前的模糊测试技术和工具仍然在输入生成、仿真、 监控、异常检测等各个方面存在局限性。 

对于同源性分析技术, 目前的技术已支持大规 模固件的多层次关联, 从而实现同源漏洞的发现。之 后的发展方向应该是针对特定漏洞类型, 有效提取 特征并进行编码, 从而实现特定类型同源漏洞的精 准, 快速发现。 

总体来说, 物联网设备漏洞挖掘技术仍然处于 起步阶段, 未来我们仍将从这三大类技术入手, 一 方面提出通用性的方法和技术, 另一方面也将针对 特定类型的设备、漏洞, 研究相应的挖掘技术。 